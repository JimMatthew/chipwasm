<!DOCTYPE html>
<html>

<head>
  <title>CHIP-8 Emulator</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      text-align: center;
      padding: 20px;
    }

    h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }

    canvas {
      border: 4px solid #2c3e50;
      border-radius: 8px;
      background-color: black;

      margin-bottom: 20px;
    }

    input[type="button"],
    select {
      padding: 10px 15px;
      margin: 5px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background-color: #3498db;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    input[type="button"]:hover,
    select:hover {
      background-color: #2980b9;
    }

    input[type="file"] {
      margin: 10px 0;
    }

    p,
    strong {
      font-size: 14px;
      max-width: 600px;
      margin: 0 auto 20px;
      line-height: 1.5;
    }

    ul {
      text-align: left;
      display: inline-block;
      margin: 0 auto 20px;
      font-size: 14px;
    }

    footer {
      margin-top: 40px;
      font-size: 12px;
      color: #777;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      background-color: #3498db;
      color: white;
    }
  </style>
  <h2>Chip-8 Emulator</h2>

</head>

<body>
  <canvas id="screen" width="640" height="320"></canvas>
  <br>

  <input type="button" id="pauseButton" value="Pause">
  <input type="button" id="resetButton" value="Reset">
  <br>
  <p>
    <br>
    <strong>Open Rom from file:</strong>
    <br>
    <input type="file" id="romLoader">
    <br><br>
    <strong>Select Rom to load:</strong>
    <br>
    <select id="romSelect">
      <option value="">-- Select a ROM --</option>
      <option value="roms/ibm.ch8">IBM</option>
      <option value="roms/particles.ch8">Particles</option>
      <option value="roms/6-keypad.ch8">keypad</option>
      <option value="roms/breakout.rom">Breakout</option>
      <option value="roms/Clock.ch8">Clock</option>
      <option value="roms/Tetris.ch8">Tetris</option>
      <option value="roms/flightrunner.ch8">Flightrunner</option>
    </select>
    <br><br>
    <strong>About:</strong>
    <br><br>
    This is a simple CHIP-8 emulator. The core emulator logic is implemented in C and compiled to WebAssembly.
    The input handling and rendering is done in JavaScript.
    <br> <a href="https://github.com/JimMatthew/chipwasm" target="_blank">View on GitHub</a>
    <br><br>
    <strong>Controls:</strong>
  <ul>
    <li>1, 2, 3, 4 - 1, 2, 3, C</li>
    <li>Q, W, E, R - 4, 5, 6, D</li>
    <li>A, S, D, F - 7, 8, 9, E</li>
    <li>Z, X, C, V - A, 0, B, F</li>
  </ul>
  <p>
    <strong>Instructions:</strong>
  <ul>
    <li>Select a ROM file using the file input.</li>
    <li>Press the keys as indicated above to control the emulator.</li>
    <li>Click "Pause" to pause the emulator.</li>
    <li>Click "Reset" to reset the emulator.</li>
  </ul>
  <p>
  </p>
  <footer>
    <p> Created by James Lindstrom</p>
  </footer>
  <script type="module">
    import createModule from './core.js';

    createModule().then((Module) => {
      const init = Module.cwrap('init', 'void', []);
      const cycle = Module.cwrap('cycle', 'void', []);
      const load_program = Module.cwrap('loadROM', 'void', ['number', 'number']);
      const getDisplay = Module.cwrap('getDisplay', 'number', []);
      const pressKey = Module.cwrap('pressKey', 'void', ['number']);
      const releaseKey = Module.cwrap('releaseKey', 'void', ['number']);
      const getDisplayPtr = Module.cwrap('getDisplay', 'number', []);
      const reset = Module.cwrap('reload', 'void', []);
      const pauseChip = Module.cwrap('pauseChip', 'void', []);
      const tick = Module.cwrap('tick', 'void', []);
      init();

      const canvas = document.getElementById("screen");
      const ctx = canvas.getContext("2d");
      const scale = 10;
      const display = new Uint8Array(Module.HEAPU8.buffer, getDisplayPtr(), 64 * 32);

      function drawDisplay() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#FFFFFF";

        for (let y = 0; y < 32; y++) {
          for (let x = 0; x < 64; x++) {
            if (display[y * 64 + x]) {
              ctx.fillRect(x * scale, y * scale, scale, scale);
            }
          }
        }
      }

      let emulationStarted = false;

      function startEmulation() {
        if (emulationStarted) return;
        emulationStarted = true;

        setInterval(() => {
          for (let i = 0; i < 10; i++) cycle();
          drawDisplay();
          tick();
        }, 1000 / 60);
      }

      document.getElementById("romLoader").onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function () {
          const bytes = new Uint8Array(reader.result);
          const buf = Module._malloc(bytes.length);
          Module.HEAPU8.set(bytes, buf);
          load_program(buf, bytes.length);
          Module._free(buf);
          startEmulation();
        };
        reader.readAsArrayBuffer(file);
      };

      const keyMap = {
        '1': 0x1, '2': 0x2, '3': 0x3, '4': 0xC,
        'q': 0x4, 'w': 0x5, 'e': 0x6, 'r': 0xD,
        'a': 0x7, 's': 0x8, 'd': 0x9, 'f': 0xE,
        'z': 0xA, 'x': 0x0, 'c': 0xB, 'v': 0xF
      };

      window.addEventListener('keydown', (e) => {
        const key = keyMap[e.key.toLowerCase()];
        if (key !== undefined) pressKey(key);
      });

      window.addEventListener('keyup', (e) => {
        const key = keyMap[e.key.toLowerCase()];
        if (key !== undefined) releaseKey(key);
      });

      document.getElementById("resetButton").addEventListener("click", () => {
        reset();
        drawDisplay();
      });

      document.getElementById("pauseButton").addEventListener("click", () => {
        pauseChip();
      });

      document.getElementById("romSelect").onchange = (e) => {
        const url = e.target.value;
        if (!url) return;

        fetch(url)
          .then(res => res.arrayBuffer())
          .then(buffer => {
            const bytes = new Uint8Array(buffer);
            const buf = Module._malloc(bytes.length);
            Module.HEAPU8.set(bytes, buf);
            load_program(buf, bytes.length);
            startEmulation(); 
          });
      };
    });
  </script>
</body>

</html>